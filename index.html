<!DOCTYPE html>
<html>
    <head>
      <meta charset="utf-8">
      <meta name="theme-color" content="#AB2B37">
      <title>GGears</title>
      <link rel="icon" type="image/x-icon" href="icon.svg">
      <link rel="manifest" href="/manifest.json">
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Raleway:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    </head>
    <style>
      @font-face { font-family: SFpro; src: url('font/SFpro-regular.OTF'); }

      .raleway-font {
        font-family: "Raleway", serif;
        font-optical-sizing: auto;
        font-weight: 10;
        font-style: normal;
      }

      :root {
        --bg-dark: rgba(28, 28, 30, 1);
        --bg-light: rgba(242, 242, 247, 1);
      }

      #map {
        height: calc(100% - 35mm);
        width: 100%;
      }

      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        background-color: #AB2B37;
      }

      #hud {
        width: 96vw;
        position: absolute; 
        bottom: 2vw;
        border-radius: 140px;
        background-color: var(--bg-dark);
        left: 50%;
        transform: translateX(-50%);
        box-shadow: rgba(0,0,0,0.5) 0 0 3px;
      }

      #header {
        background-color: #AB2B37;
        color: white;
        height: 45mm;
      }

      #profileButton {
        height: 25mm;
        filter: invert();
        box-shadow: gray 0px 0px 5px;
        border-radius: 100%;
      }

      #profileLink {
        position:absolute;
        right: 10mm;
        top: 10mm;
      }

      #userName {
        position: absolute; 
        left: 50%;
        top: 25%;
        transform: translate(-50%, -25%);
      }

      .logo {
        position:absolute;
        left: 7mm;
        top: 7mm;
        width: 30mm;
      }

      .text-center {
        text-align: center;
      }

      h1 {
        font-size: 18mm;
        font-weight: 800;
      }

      h2 {
        font-size: 10mm;
      }

      h1, h2, h3, h4, h5, p {
        color: black;
        font-family: "Raleway", serif;
        font-optical-sizing: auto;
        text-shadow: rgba(0,0,0,.01) 0 0 1px;
        text-rendering: optimizeLegibility;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      @media (prefers-color-scheme: light) {
        #hud {
          background-color: var(--bg-light);
        }

        h1, h2, h3, h4, h5, p {
          color: black;
        }
      }

      @media (prefers-color-scheme: dark) {
        #hud {
          background-color: var(--bg-dark);
        }

        h1, h2, h3, h4, h5, p {
          color: white;
        }
      }
    </style>
    <body>
      <div id="header">
        <img class="logo" src="icon-white.svg" alt="Logo"></img>
        <h1 class="text-center" style="position: absolute; left: 50%; transform: translateX(-50%); width: 100%; top: -5mm;">Gompei's Gears</h1>
        <p class="text-center" style="position: absolute; left: 50%; transform: translateX(-50%); width: 100%; top: 20mm; font-size: 8mm;">WPI Bicycle Rental</p>
        <a href="javascript:updateLogin()" id="profileLink"><img alt="profile" id="profileButton" src="profile.svg"><h3 id="userName" class="text-center"></h3></img></a>
      </div>
      <div id="map"></div>
      <div id="overlay">
        <div id="hud">
          <h1 id="greeter" class="text-center">
            Select a Station to Begin
          </h1>
          <h2 id="greeter" class="text-center" style="padding-top: 10px;">
            You found me!
          </h2>
        </div>
      </div>
    </body>
    <footer>
      <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
      <script>
        (g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.${c}apis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})({
          key: "AIzaSyCps00S-IyycrnY2IUxz6qeHuTVbcn_zIw",
          v: "weekly",
          // Use the 'v' parameter to indicate the version to use (weekly, beta, alpha, etc.).
          // Add other bootstrap parameters as needed, using camel case.
        });
      </script>
      <script>
        zones = []
        let mainMap

        async function initMap() {
          const { Map } = await google.maps.importLibrary("maps");

          mainMap = new Map(document.getElementById("map"), {
            zoom: 19,
            center: { lat: 42.273836, lng: -71.809810 },
            mapId: 'DEMO_MAP_ID',
            mapTypeId: "satellite",
            mapTypeControl: true,
            mapTypeControlOptions: {
              style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
              position: google.maps.ControlPosition.TOP_CENTER,
            },
            zoomControl: true,
            zoomControlOptions: {
              position: google.maps.ControlPosition.RIGHT_CENTER,
            },
            scaleControl: false,
            streetViewControl: false,
            fullscreenControl: false,
            rotateControl: true,
            rotateControlOptions: {
              position: google.maps.ControlPosition.LEFT_CENTER,
            },
            controlSize: 50,
          });

          fetch(`${window.location.href}server/zones.csv`).then(response => {
            return response.text()
          }).then(data => {
            generateZones(data)
          });

        }

        async function generateZones(csvIn) {
          const { AdvancedMarkerElement, PinElement } = await google.maps.importLibrary("marker");
          map = mainMap

          data = csvIn.split("\n")
          data = data.filter(item => item.includes("POLYGON"));
          data = data.map(item => item.substr(item.indexOf("((")+2,item.len).split(`))",`).reverse())
          data = data.map(item => [item[0], item[1].split(", ")])
          
          for(i in data) {
            let cords = []
            for(j in data[i][1]) {
              arr = data[i][1][j].split(" ").reverse()
              cords.push({ lat : Number(arr[0]), lng : Number(arr[1])})
            }
            const zone = new google.maps.Polygon({
              paths: cords,
              strokeColor: "#FF0000",
              strokeOpacity: 0.8,
              strokeWeight: 2,
              fillColor: "#FF0000",
              fillOpacity: 0.35,
            });
            const pin = new PinElement({
              scale: 3,
            });
            const marker = new AdvancedMarkerElement({
              map,
              position: cords[0],
              content: pin.element,
              title: data[i][0],
              gmpClickable: true,
            });
            marker.addListener("click", ({ domEvent, latLng }) => {
              const { target } = domEvent;

              moved = 1
              handleUp()
            });
            zone.setMap(mainMap)
            zones.push(zone)
          }
        }

        initMap();
      </script>
      <script>

        document.getElementById("hud").onpointerdown = handleTouch
        document.getElementById("hud").onpointercancel = handleTouch
        document.onpointermove = handleMove
        document.onpointerup = handleUp
        document.getElementById("hud").addEventListener("touchmove", preventDef)

        function preventDef(evt) {
          evt.preventDefault()
        }

        touch0 = 0 //Where the touch was first performed
        moved = 0 //Record if the pointer moved
        movement = 0 //The current movement of the item in pixels
        mode = 0
        initHeight = "80mm" //Initial height of the HUD
        openHeight = "50%"
        document.getElementById("hud").style.height = initHeight
        setHeight = initHeight

        function handleTouch(evt) { //Handle touches
          touch0 = evt.pageY + movement
          moved = 1
        }

        function handleMove(evt) {
          if(moved != 0) {
            document.getElementById("hud").style.transition = ""
            moved = 2
            movement = (touch0 - evt.pageY)
            document.getElementById("hud").style.height = `calc(${setHeight} + ${movement}px)`
            truHeight = parseInt(window.getComputedStyle(document.getElementById("hud")).getPropertyValue("height"), 10)
            if(truHeight < (window.innerHeight * 0.08)) {
              document.getElementById("hud").style.height = `${(window.innerHeight * 0.08)}px`
            } else if (truHeight > (window.innerHeight * 0.6)) {
              document.getElementById("hud").style.height = `${(window.innerHeight * 0.6)}px`
            }
          }
        }

        function handleUp(evt) {
          if(moved != 0) {
            if(moved == 1) {mode = (mode == 0) ? 1:0}
            if(movement > 300 && mode == 0) {
              mode = 1
            } else if(movement < -300 && mode == 1) {
              mode = 0
            }
            if(mode == 0) {
              setHeight = initHeight
            } else {
              setHeight = openHeight
            }
            movement = 0
            document.getElementById("hud").style.transition = "height 0.2s ease-out"
            document.getElementById("hud").style.height = setHeight
            moved = 0
          }
        }
      </script>
      <script>
        login = false
        name = "Goocie Gorl"

        function updateLogin() {
          login = !login
          if(login) {
            document.getElementById("profileButton").src = "outline.svg"
            document.getElementById("userName").textContent = name
          } else {
            document.getElementById("profileButton").src = "profile.svg"
            document.getElementById("userName").textContent = ""
          }
        }
      </script>
    </footer>
</html>